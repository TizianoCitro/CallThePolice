apiVersion: "nuclio.io/v1"
kind: Function
metadata:
  name: notify-police
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "Sends a security alert to the police"
  runtime: nodejs
  image: "nuclio/processor-amqpconsume:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    amqp-police-trigger:
      class: ""
      kind: rabbit-mq
      url: "amqp://guest:guest@192.168.1.164:5672"
      attributes:
        exchangeName: notify/police
        queueName: notify/police
        topics:
          - security
  build:
    functionSourceCode: Y29uc3QgYW1xcCA9IHJlcXVpcmUoJ2FtcXBsaWInKTsKY29uc3QgYXdzID0gcmVxdWlyZSgiYXdzLXNkayIpOwpjb25zdCB7IHY0OiB1dWlkdjQgfSA9IHJlcXVpcmUoJ3V1aWQnKTsKCmNvbnN0IHVybCA9ICJhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTkyLjE2OC4xLjE2NDo1NjcyIjsKY29uc3QgcG9saWNlUXVldWUgPSAibm90aWZ5L3BvbGljZS90ZXJtaW5hbCI7CmNvbnN0IHRhYmxlID0gIlBvbGljZVJlcG9ydCI7Cgphd3MuY29uZmlnLnVwZGF0ZSh7CiAgICByZWdpb246ICJ1cy1lYXN0LTEiLAogICAgZW5kcG9pbnQ6ICJodHRwOi8vMTkyLjE2OC4xLjE2NDo4MDAwIiwKICAgIGFjY2Vzc0tleUlkOiAiWU9VUl9LRVkiLAogICAgc2VjcmV0QWNjZXNzS2V5OiAiWU9VUl9TRUNSRVQiCn0pOwoKY29uc3QgZHluYW1vREIgPSBuZXcgYXdzLkR5bmFtb0RCKCk7CmNvbnN0IGRvY3VtZW50Q2xpZW50ID0gbmV3IGF3cy5EeW5hbW9EQi5Eb2N1bWVudENsaWVudCgpOwoKZnVuY3Rpb24gYmluMnN0cmluZyhhcnJheSkgewogICAgbGV0IHJlc3VsdCA9ICIiOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgIHJlc3VsdCArPSAoU3RyaW5nLmZyb21DaGFyQ29kZShhcnJheVtpXSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gY3JlYXRlVGFibGVJZk5vdEV4aXN0cygpIHsKICAgIGR5bmFtb0RCLmxpc3RUYWJsZXMoe30pCiAgICAgICAgLnByb21pc2UoKQogICAgICAgIC50aGVuKChkYXRhKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHRhYmxlRXhpc3RzID0gZGF0YS5UYWJsZU5hbWVzCiAgICAgICAgICAgICAgICAuZmlsdGVyKG5hbWUgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lID09PSB0YWJsZTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAubGVuZ3RoID4gMDsKCiAgICAgICAgICAgIGlmICh0YWJsZUV4aXN0cykgewogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUsCiAgICAgICAgICAgICAgICAgICAgS2V5U2NoZW1hOiBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogImlkIiwgS2V5VHlwZTogIkhBU0gifSwKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsgQXR0cmlidXRlTmFtZTogImlkIiwgQXR0cmlidXRlVHlwZTogIlMiIH0KICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIFByb3Zpc2lvbmVkVGhyb3VnaHB1dDogewogICAgICAgICAgICAgICAgICAgICAgICBSZWFkQ2FwYWNpdHlVbml0czogMywKICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGVDYXBhY2l0eVVuaXRzOiAzCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBkeW5hbW9EQi5jcmVhdGVUYWJsZShwYXJhbXMpLnByb21pc2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwp9CgpmdW5jdGlvbiBzYXZlUG9saWNlUmVwb3J0KGFsZXJ0KSB7CiAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgVGFibGVOYW1lOiB0YWJsZSwKICAgICAgICBJdGVtOiB7CiAgICAgICAgICAgIGlkOiB1dWlkdjQoKS50b1N0cmluZygpLAogICAgICAgICAgICBhbGVydAogICAgICAgIH0KICAgIH07CgogICAgZG9jdW1lbnRDbGllbnQucHV0KHBhcmFtcywgKGVyciwgZGF0YSkgPT4gewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgVW5hYmxlIHRvIGFkZCBpdGVtIGR1ZSB0byBlcnJvcjogJHtKU09OLnN0cmluZ2lmeShlcnIsIG51bGwsIDIpfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBZGRlZCBpdGVtOjogJHtKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKX1gKTsKICAgICAgICB9CiAgICB9KTsKfQoKZnVuY3Rpb24gbm90aWZ5UG9saWNlKGFsZXJ0KSB7CiAgICBhbXFwLmNvbm5lY3QodXJsKS50aGVuKGZ1bmN0aW9uKGNvbm5lY3Rpb24pIHsKICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5jcmVhdGVDaGFubmVsKCkudGhlbihmdW5jdGlvbihjaGFubmVsKSB7CiAgICAgICAgICAgIGNvbnN0IG9rID0gY2hhbm5lbC5hc3NlcnRRdWV1ZShwb2xpY2VRdWV1ZSwge2R1cmFibGU6IGZhbHNlfSk7CiAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKICAgICAgICAgICAgICAgIGNoYW5uZWwuc2VuZFRvUXVldWUocG9saWNlUXVldWUsIEJ1ZmZlci5mcm9tKGFsZXJ0KSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU2VudCAke2FsZXJ0fSBvbiAke3BvbGljZVF1ZXVlfWApOwoKICAgICAgICAgICAgICAgIHNhdmVQb2xpY2VSZXBvcnQoYWxlcnQpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFNhdmVkICR7YWxlcnR9IGluICR7dGFibGV9YCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5uZWwuY2xvc2UoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuZmluYWxseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgY29ubmVjdGlvbi5jbG9zZSgpOwogICAgICAgIH0pOwogICAgfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQoKZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIGNvbnN0IHBhcnNlZEV2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOwogICAgY29uc3QgYWxlcnQgPSBiaW4yc3RyaW5nKHBhcnNlZEV2ZW50LmJvZHkuZGF0YSk7CgogICAgYXdhaXQgY3JlYXRlVGFibGVJZk5vdEV4aXN0cygpOwoKICAgIGNvbnRleHQuY2FsbGJhY2soYWxlcnQpOwoKICAgIG5vdGlmeVBvbGljZShhbGVydCk7Cn07
    commands:
      - "npm install amqplib"
      - "npm install aws-sdk"
    codeEntryType: sourceCode
  platform: {}