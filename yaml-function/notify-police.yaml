apiVersion: "nuclio.io/v1"
kind: Function
metadata:
  name: notify-police
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "Sends a security alert to the police"
  runtime: nodejs
  image: "nuclio/processor-amqpconsume:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    amqp-police-trigger:
      class: ""
      kind: rabbit-mq
      url: "amqp://guest:guest@192.168.1.164:5672"
      attributes:
        exchangeName: notify/police
        queueName: notify/police
        topics:
          - security
  build:
    functionSourceCode: Y29uc3QgYW1xcCA9IHJlcXVpcmUoJ2FtcXBsaWInKTsKCmNvbnN0IHVybCA9ICJhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTkyLjE2OC4xLjE2NDo1NjcyIjsKY29uc3QgcG9saWNlUXVldWUgPSAibm90aWZ5L3BvbGljZS90ZXJtaW5hbCI7CgpmdW5jdGlvbiBiaW4yc3RyaW5nKGFycmF5KSB7CiAgICBsZXQgcmVzdWx0ID0gIiI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgcmVzdWx0ICs9IChTdHJpbmcuZnJvbUNoYXJDb2RlKGFycmF5W2ldKSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBub3RpZnlQb2xpY2UoYWxlcnQpIHsKICAgIGFtcXAuY29ubmVjdCh1cmwpLnRoZW4oZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgICAgIHJldHVybiBjb25uZWN0aW9uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoYW5uZWwpIHsKICAgICAgICAgICAgY29uc3Qgb2sgPSBjaGFubmVsLmFzc2VydFF1ZXVlKHBvbGljZVF1ZXVlLCB7ZHVyYWJsZTogZmFsc2V9KTsKICAgICAgICAgICAgcmV0dXJuIG9rLnRoZW4oZnVuY3Rpb24oX3FvaykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5zZW5kVG9RdWV1ZShwb2xpY2VRdWV1ZSwgQnVmZmVyLmZyb20oYWxlcnQpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTZW50ICR7YWxlcnR9IG9uICR7cG9saWNlUXVldWV9YCk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hhbm5lbC5jbG9zZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KS5maW5hbGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb25uZWN0aW9uLmNsb3NlKCk7CiAgICAgICAgfSk7CiAgICB9KS5jYXRjaChjb25zb2xlLndhcm4pOwp9CgpleHBvcnRzLmhhbmRsZXIgPSBmdW5jdGlvbihjb250ZXh0LCBldmVudCkgewogICAgY29uc3QgcGFyc2VkRXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7CiAgICBjb25zdCBhbGVydCA9IGJpbjJzdHJpbmcocGFyc2VkRXZlbnQuYm9keS5kYXRhKTsKCiAgICBjb250ZXh0LmNhbGxiYWNrKGFsZXJ0KTsKCiAgICBub3RpZnlQb2xpY2UoYWxlcnQpOwp9Ow==
    commands:
      - "npm install amqplib"
    codeEntryType: sourceCode
  platform: {}