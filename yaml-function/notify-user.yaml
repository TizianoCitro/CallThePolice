apiVersion: "nuclio.io/v1"
kind: Function
metadata:
  name: notify-user
  namespace: nuclio
spec:
  handler: "main:handler"
  description: "Sends a security alert to the user"
  runtime: nodejs
  image: "nuclio/processor-amqpconsume:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    amqp-user-trigger:
      class: ""
      kind: rabbit-mq
      url: "amqp://guest:guest@192.168.1.164:5672"
      attributes:
        exchangeName: notify/user
        queueName: notify/user
        topics:
          - security
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7Cgpjb25zdCB1cmwgPSAiYW1xcDovL2d1ZXN0Omd1ZXN0QDE5Mi4xNjguMS4xNjQ6NTY3MiI7CmNvbnN0IHVzZXJUZXJtaW5hbFF1ZXVlID0gIm5vdGlmeS91c2VyL3Rlcm1pbmFsIjsKCmZ1bmN0aW9uIG5vdGlmeVVzZXIoYWxlcnQpIHsKICAgIGFtcXAuY29ubmVjdCh1cmwpLnRoZW4oZnVuY3Rpb24oY29ubikgewogICAgICAgIHJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHVzZXJUZXJtaW5hbFF1ZXVlLCB7ZHVyYWJsZTogZmFsc2V9KTsKICAgICAgICAgICAgcmV0dXJuIG9rLnRoZW4oZnVuY3Rpb24oX3FvaykgewogICAgICAgICAgICAgICAgY2guc2VuZFRvUXVldWUodXNlclRlcm1pbmFsUXVldWUsIEJ1ZmZlci5mcm9tKGFsZXJ0KSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgU2VudCAke2FsZXJ0fSBvbiAke3VzZXJUZXJtaW5hbFF1ZXVlfWApOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoLmNsb3NlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7IGNvbm4uY2xvc2UoKTsgfSk7CiAgICB9KS5jYXRjaChjb25zb2xlLndhcm4pOwp9CgpmdW5jdGlvbiBiaW4yc3RyaW5nKGFycmF5KSB7CiAgICB2YXIgcmVzdWx0ID0gIiI7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICByZXN1bHQgKz0gKFN0cmluZy5mcm9tQ2hhckNvZGUoYXJyYXlbaV0pKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn0KCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7CiAgICB2YXIgcGFyc2VkRXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7CiAgICB2YXIgYWxlcnQgPSBiaW4yc3RyaW5nKHBhcnNlZEV2ZW50LmJvZHkuZGF0YSk7CgogICAgY29udGV4dC5jYWxsYmFjayhhbGVydCk7CgogICAgbm90aWZ5VXNlcihhbGVydCk7Cn07
    commands:
      - "npm install amqplib"
    codeEntryType: sourceCode
  platform: {}